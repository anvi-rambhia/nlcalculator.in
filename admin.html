<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kore Mobiles ‚Äî Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--blue:#007bff;--green:#28a745;--red:#dc3545;--bg:#f7f9fc}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg);color:#111}
.wrap{max-width:1000px;margin:18px auto;padding:14px}

h2{color:var(--blue);margin:0;font-size:1.4rem}

.btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
.primary{background:var(--blue);color:#fff}
.logout{background:var(--red);color:#fff}

input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}

#loginBox{max-width:350px;margin:60px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.1);}

.layout{display:grid;grid-template-columns:1fr 420px;gap:14px}
.panel{background:#fff;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:.95rem;vertical-align:middle}
.actions button{margin-right:6px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
.edit{background:#ffc107;color:#111}
.del{background:#dc3545;color:#fff}
.add{background:var(--green);color:#fff}
.note{font-size:.9rem;color:#666;margin-top:8px}

@media(max-width:900px){
  .layout{grid-template-columns:1fr}
}
</style>
</head>

<body>

<!-- üî• LOGIN BOX FIRST -->
<div id="loginBox">
  <h2>Admin Login</h2>
  <label>Email</label>
  <input id="loginEmail" type="email" placeholder="Enter admin email">
  
  <label>Password</label>
  <input id="loginPassword" type="password" placeholder="Enter password">

  <button class="btn primary" style="width:100%;margin-top:12px" onclick="loginAdmin()">Login</button>
</div>

<!-- üî• DASHBOARD HIDDEN UNTIL LOGIN -->
<div id="dashboard" style="display:none;">
<div class="wrap">

<div class="header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
  <h2>‚öôÔ∏è Admin Dashboard</h2>

  <div style="display:flex;gap:8px">
    <button class="btn primary" onclick="showPanel('modelsPanel')">üì± Models</button>
    <button class="btn primary" onclick="showPanel('usersPanel')">üë§ Users</button>
    <button class="btn logout" onclick="logoutAdmin()">Logout</button>
  </div>
</div>

<!-- MODELS PANEL -->
<div id="modelsPanel" class="layout">
  <div class="panel">
    <h3>Models</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Model</th><th>MOP</th><th>DP</th><th>PreGST</th>
          <th>Sellout</th><th>Sellin</th><th>NoCost</th>
          <th>Swipe</th><th>UPI</th><th>Banks</th>
          <th>Features</th><th>Upgrade</th><th>Finance</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="modelsTbody"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Add / Edit Model</h3>
    <label>Model Name</label><input id="m_name"/>
    <label>MOP</label><input id="m_mop" type="number"/>
    <label>DP</label><input id="m_dp" type="number" oninput="calcPreGst()"/>
    <label>Pre-GST</label><input id="m_preGst" readonly/>
    <label>Sellout</label><input id="m_sellout" type="number"/>
    <label>Sellin</label><input id="m_sellin" type="number"/>
    <label>No Cost EMI</label><input id="m_noCostEmi" type="number"/>
    <label>Full Swipe</label><input id="m_fullSwipe" type="number"/>
    <label>UPI Cashback</label><input id="m_upiCashback" type="number"/>
    <label>Eligible Banks</label><input id="m_eligibleBanks"/>
    <label>Features</label><input id="m_features"/>
    <label>Upgrade</label><input id="m_upgrade" type="number"/>
    <label>Finance Upgrade</label><input id="m_upgradeFinance" type="number"/>

    <button class="btn add" onclick="saveModel()">Save Model</button>
  </div>
</div>

<!-- USERS PANEL -->
<div id="usersPanel" class="layout" style="display:none;">
  <div class="panel">
    <h3>Users</h3>
    <table class="table">
      <thead><tr><th>Email</th><th>Name</th><th>Actions</th></tr></thead>
      <tbody id="usersTbody"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Add / Edit User</h3>
    <label>Name</label><input id="u_name"/>
    <label>Email</label><input id="u_email" type="email"/>
    <label>Password</label><input id="u_pass" type="password"/>
    <button class="btn add" onclick="saveUser()">Save User</button>
  </div>
</div>

</div>
</div>

<!-- üî• JAVASCRIPT -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import { 
  getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyByEiFSbsDlrCtVJjZgvbCoYPt_io2CpTk",
  authDomain: "nlcalulator.firebaseapp.com",
  projectId: "nlcalulator",
  storageBucket: "nlcalulator.firebasestorage.app",
  messagingSenderId: "783940164431",
  appId: "1:783940164431:web:edd9e24a8e6901942b433a",
  measurementId: "G-D8CXJYMPG0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let editModelId = null;

window.loginAdmin = function(){
  const email = loginEmail.value.trim();
  const pass = loginPassword.value.trim();

  signInWithEmailAndPassword(auth, email, pass)
  .then(()=>{
    loginBox.style.display = "none";
    dashboard.style.display = "block";
    loadModels();
  })
  .catch(()=> alert("Invalid Email or Password"));
};

window.logoutAdmin = function(){
  signOut(auth);
};

// Auto login session
onAuthStateChanged(auth, (user)=>{
  if(user){
    loginBox.style.display="none";
    dashboard.style.display="block";
    loadModels();
  } else {
    dashboard.style.display="none";
    loginBox.style.display="block";
  }
});

// ===================== MODELS =====================
// (same as your original functions)
// ---------------------
// LOAD MODELS
window.loadModels = async function(){
  const tbody = modelsTbody;
  tbody.innerHTML="<tr><td colspan=10>Loading...</td></tr>";

  const snap = await getDocs(collection(db,'mobileModels'));

  tbody.innerHTML="";
  snap.forEach(docSnap=>{
    const m = docSnap.data();
    const id = docSnap.id;

    const row = `
    <tr>
      <td>${m.name||''}</td>
      <td>‚Çπ${m.mop||0}</td>
      <td>‚Çπ${m.dp||0}</td>
      <td>‚Çπ${m.preGstDp||0}</td>
      <td>‚Çπ${m.sellout||0}</td>
      <td>‚Çπ${m.sellin||0}</td>
      <td>‚Çπ${m.noCostEmi||0}</td>
      <td>‚Çπ${m.fullSwipe||0}</td>
      <td>‚Çπ${m.upiCashback||0}</td>
      <td>${(m.eligibleBanks||[]).join(', ')}</td>
      <td>${m.features||''}</td>
      <td>‚Çπ${m.upgrade||0}</td>
      <td>‚Çπ${m.upgradeFinance||0}</td>
      <td>
        <button class='edit' onclick="startEditModel('${id}','${m.name}',${m.mop},${m.dp},${m.sellout},${m.sellin},${m.noCostEmi},${m.fullSwipe},${m.upiCashback},'${(m.eligibleBanks||[]).join(', ')}','${m.features}',${m.upgrade},${m.upgradeFinance})">Edit</button>
        <button class='del' onclick="deleteModel('${id}')">Delete</button>
      </td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
};

// SAVE MODEL
window.saveModel = async function(){
  const payload = {
    name: m_name.value.trim(),
    mop: Number(m_mop.value)||0,
    dp: Number(m_dp.value)||0,
    preGstDp: m_preGst.value?Number(m_preGst.value):0,
    sellout: Number(m_sellout.value)||0,
    sellin: Number(m_sellin.value)||0,
    noCostEmi: Number(m_noCostEmi.value)||0,
    fullSwipe: Number(m_fullSwipe.value)||0,
    upiCashback: Number(m_upiCashback.value)||0,
    eligibleBanks: m_eligibleBanks.value.trim()?m_eligibleBanks.value.split(','):[],
    features: m_features.value.trim(),
    upgrade: Number(m_upgrade.value)||0,
    upgradeFinance: Number(m_upgradeFinance.value)||0,
    updatedAt: new Date()
  };

  if(editModelId){
    await updateDoc(doc(db,'mobileModels',editModelId), payload);
    alert("Model Updated");
  } else {
    await addDoc(collection(db,'mobileModels'), payload);
    alert("Model Added");
  }

  clearModelForm();
  loadModels();
};

window.startEditModel = function(id,name,mop,dp,sellout,sellin,noCostEmi,fullSwipe,upi,banks,features,upgrade,upgradeFinance){
  editModelId=id;
  m_name.value=name;
  m_mop.value=mop;
  m_dp.value=dp;
  m_sellout.value=sellout;
  m_sellin.value=sellin;
  m_noCostEmi.value=noCostEmi;
  m_fullSwipe.value=fullSwipe;
  m_upiCashback.value=upi;
  m_eligibleBanks.value=banks;
  m_features.value=features;
  m_upgrade.value=upgrade;
  m_upgradeFinance.value=upgradeFinance;
  calcPreGst();
};

window.deleteModel = async function(id){
  if(confirm("Delete model?")){
    await deleteDoc(doc(db,'mobileModels',id));
    loadModels();
  }
};

window.clearModelForm = function(){
  editModelId=null;
  [m_name,m_mop,m_dp,m_sellout,m_sellin,m_preGst,m_noCostEmi,m_fullSwipe,m_upiCashback,m_eligibleBanks,m_features,m_upgrade,m_upgradeFinance]
  .forEach(el=>el.value="");
};

window.calcPreGst = function(){
  const dp = Number(m_dp.value)||0;
  m_preGst.value = dp?(dp/1.18).toFixed(2):"";
};

// ===================== USERS =====================
window.loadUsers = async function(){
  const tbody = usersTbody;
  tbody.innerHTML="<tr><td colspan=3>Loading...</td></tr>";

  const snap = await getDocs(collection(db,'users'));
  tbody.innerHTML="";

  snap.forEach(docSnap=>{
    const u=docSnap.data();
    const id=docSnap.id;

    const row = `
    <tr>
      <td>${u.email}</td>
      <td>${u.name}</td>
      <td><button class='del' onclick="deleteUser('${id}')">Delete</button></td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
};

window.saveUser = async function(){
  const name=u_name.value.trim();
  const email=u_email.value.trim();
  const pass=u_pass.value.trim();

  if(!name||!email||!pass) return alert("Fill all fields");

  await addDoc(collection(db,'users'),{
    name,email,createdAt:new Date()
  });

  alert("User Saved");
  u_name.value="";u_email.value="";u_pass.value="";
  loadUsers();
};

window.deleteUser = async function(id){
  if(confirm("Delete user?")){
    await deleteDoc(doc(db,'users',id));
    loadUsers();
  }
};

window.showPanel = function(id){
  modelsPanel.style.display="none";
  usersPanel.style.display="none";

  document.getElementById(id).style.display="grid";

  if(id==="modelsPanel") loadModels();
  if(id==="usersPanel") loadUsers();
};

</script>

</body>
</html>
