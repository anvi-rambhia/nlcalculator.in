<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kore Mobiles ‚Äî Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--blue:#007bff;--green:#28a745;--red:#dc3545;--bg:#f7f9fc}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg);color:#111}
.wrap{max-width:1200px;margin:18px auto;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
h2{color:var(--blue);margin:0;font-size:1.4rem}
.btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
.primary{background:var(--blue);color:#fff}
.logout{background:var(--red);color:#fff}
.layout{display:grid;grid-template-columns:1fr 420px;gap:14px}
.panel{background:#fff;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
.form-row{display:flex;gap:10px;flex-wrap:wrap}
.form-row .half{flex:1;min-width:140px}
label{font-weight:600;font-size:.95rem;margin-top:6px;display:block}
.small{font-size:.95rem;color:#444}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:.95rem;vertical-align:middle}
.actions button{margin-right:6px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
.edit{background:#ffc107;color:#111}
.del{background:#dc3545;color:#fff}
.add{background:var(--green);color:#fff}
.note{font-size:.9rem;color:#666;margin-top:8px}
.search-row{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.kv{font-size:0.95rem;color:#333}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef3ff;color:#0451b3;font-weight:600;margin-left:6px}
@media(max-width:900px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <h2>‚öôÔ∏è Admin Dashboard</h2>
    <div style="display:flex;gap:8px">
      <button class="btn primary" onclick="openUserPanel()">Open User Panel</button>
      <button class="btn logout" onclick="adminLogout()">Logout</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Models Section -->
    <div class="panel">
      <h3>üì± Models</h3>
      <div class="search-row">
        <input id="filterInput" placeholder="Filter by name / ram / rom" style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee" oninput="loadModels()" />
        <button class="btn" onclick="loadModels()">Refresh</button>
        <button class="btn" onclick="exportModels()">Export JSON</button>
      </div>

      <table class="table">
        <thead><tr><th>Model</th><th>MOP</th><th>DP</th><th>Pre-GST DP</th><th>Sellout</th><th>Sellin</th><th>CC Offers</th><th>Banks</th><th>Actions</th></tr></thead>
        <tbody id="modelsTbody"></tbody>
      </table>
      <p class="note">Data is saved in Firestore ‚Üí <code>mobileModels</code></p>
    </div>

    <!-- RIGHT: Add/Edit Model -->
    <div class="panel">
      <h3>Add / Edit Model</h3>
      <label>Model Name</label>
      <input id="m_name" placeholder="e.g. Galaxy S24" />

      <div class="form-row">
        <div class="half"><label>MOP (‚Çπ)</label><input id="m_mop" type="number"/></div>
        <div class="half"><label>DP (‚Çπ)</label><input id="m_dp" type="number" oninput="calcPreGst()"/></div>
      </div>

      <div class="form-row">
        <div class="half"><label>Pre-GST DP (auto)</label><input id="m_preGst" readonly/></div>
        <div class="half"><label>Sellout Scheme (‚Çπ)</label><input id="m_sellout" type="number"/></div>
      </div>

      <div class="form-row">
        <div class="half"><label>Sellin / Purchase Scheme (‚Çπ)</label><input id="m_sellin" type="number"/></div>
        <div class="half"><label>RAM</label><input id="m_ram" placeholder="e.g. 8GB"/></div>
      </div>

      <div class="form-row">
        <div class="half"><label>ROM</label><input id="m_rom" placeholder="e.g. 128GB"/></div>
        <div class="half"><label>Credit Card No Cost EMI (‚Çπ)</label><input id="m_cc_no" type="number"/></div>
      </div>

      <div class="form-row">
        <div class="half"><label>Credit Card Full Swipe (‚Çπ)</label><input id="m_cc_full" type="number"/></div>
        <div class="half"><label>Eligible Banks (comma separated)</label><input id="m_banks" placeholder="e.g. HDFC, SBI, ICICI"/></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn add" onclick="saveModel()">Save Model</button>
        <button class="btn" onclick="clearForm()">Clear</button>
      </div>
    </div>
  </div>

  <!-- üîπ USER MANAGEMENT SECTION -->
  <div class="panel" style="margin-top:20px">
    <h3>üë§ User Management</h3>
    <div class="search-row">
      <input id="userFilter" placeholder="Search user by name or email" style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee" oninput="loadUsers()"/>
      <button class="btn" onclick="loadUsers()">Refresh</button>
    </div>

    <table class="table">
      <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody id="usersTbody"></tbody>
    </table>

    <h4 style="margin-top:20px">Add / Edit User</h4>
    <div class="form-row">
      <div class="half"><label>Name</label><input id="u_name" placeholder="Full name"/></div>
      <div class="half"><label>Email</label><input id="u_email" placeholder="example@email.com"/></div>
    </div>
    <div class="form-row">
      <div class="half"><label>Password</label><input id="u_password" placeholder="Password"/></div>
      <div class="half"><label>Role</label><input id="u_role" placeholder="admin / user"/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn add" onclick="saveUser()">Save User</button>
      <button class="btn" onclick="clearUserForm()">Clear</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, getDoc, doc,
  updateDoc, deleteDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyByEiFSbsDlrCtVJjZgvbCoYPt_io2CpTk",
  authDomain: "nlcalulator.firebaseapp.com",
  projectId: "nlcalulator",
  storageBucket: "nlcalulator.firebasestorage.app",
  messagingSenderId: "783940164431",
  appId: "1:783940164431:web:edd9e24a8e6901942b433a",
  measurementId: "G-D8CXJYMPG0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- MODEL FUNCTIONS ---------------- */
const modelCollection = "mobileModels";
let editId = null;

function fmt(n){return Number(n||0).toLocaleString('en-IN');}

window.saveModel = async function(){
  const name=document.getElementById('m_name').value.trim();
  if(!name) return alert('Enter model name');
  const dp=Number(m_dp.value)||0;
  const payload={
    name,mop:Number(m_mop.value)||0,dp,preGstDp:dp?(dp/1.18).toFixed(2):0,
    sellout:Number(m_sellout.value)||0,sellin:Number(m_sellin.value)||0,
    ram:m_ram.value,rom:m_rom.value,ccNo:Number(m_cc_no.value)||0,ccFull:Number(m_cc_full.value)||0,
    eligibleBanks:(m_banks.value.split(',').map(b=>b.trim()).filter(Boolean)),updatedAt:new Date()
  };
  try{
    if(editId){await updateDoc(doc(db,modelCollection,editId),payload);alert('Model updated')}
    else await addDoc(collection(db,modelCollection),payload),alert('Model added');
    clearForm();loadModels();
  }catch(e){alert('Error: '+e.message)}
}

window.loadModels = async function(){
  const tbody=document.getElementById('modelsTbody');tbody.innerHTML='<tr><td colspan=9>Loading...</td></tr>';
  const qText=(filterInput.value||'').toLowerCase();
  const snap=await getDocs(query(collection(db,modelCollection),orderBy('name')));
  tbody.innerHTML='';let count=0;
  snap.forEach(d=>{
    const m=d.data(),id=d.id;
    if(qText&&!`${m.name} ${m.ram} ${m.rom}`.toLowerCase().includes(qText))return;
    count++;
    tbody.innerHTML+=`
      <tr>
        <td><b>${m.name}</b><div class='small'>${m.ram}/${m.rom}</div></td>
        <td>‚Çπ${fmt(m.mop)}</td><td>‚Çπ${fmt(m.dp)}</td><td>‚Çπ${fmt(m.preGstDp)}</td>
        <td>‚Çπ${fmt(m.sellout)}</td><td>‚Çπ${fmt(m.sellin)}</td>
        <td>No Cost: ‚Çπ${fmt(m.ccNo)}<br>Full: ‚Çπ${fmt(m.ccFull)}</td>
        <td>${(m.eligibleBanks||[]).join(', ')}</td>
        <td class='actions'><button class='edit' onclick="startEdit('${id}')">Edit</button>
        <button class='del' onclick="deleteModel('${id}')">Delete</button></td>
      </tr>`;
  });
  if(!count)tbody.innerHTML='<tr><td colspan=9>No models found</td></tr>';
}

window.startEdit = async function(id){
  const snap=await getDoc(doc(db,modelCollection,id));
  if(!snap.exists())return alert('Not found');
  const m=snap.data();editId=id;
  ['name','mop','dp','preGst','sellout','sellin','ram','rom','cc_no','cc_full','banks']
  .forEach(x=>document.getElementById('m_'+x)?.value='');
  m_name.value=m.name;m_mop.value=m.mop;m_dp.value=m.dp;m_preGst.value=m.preGstDp;
  m_sellout.value=m.sellout;m_sellin.value=m.sellin;m_ram.value=m.ram;m_rom.value=m.rom;
  m_cc_no.value=m.ccNo;m_cc_full.value=m.ccFull;m_banks.value=(m.eligibleBanks||[]).join(', ');
  window.scrollTo({top:0,behavior:'smooth'});
}

window.deleteModel = async id=>{
  if(!confirm('Delete this model?'))return;
  await deleteDoc(doc(db,modelCollection,id));loadModels();
}
window.clearForm=()=>{editId=null;['m_name','m_mop','m_dp','m_preGst','m_sellout','m_sellin','m_ram','m_rom','m_cc_no','m_cc_full','m_banks'].forEach(i=>document.getElementById(i).value='');}
window.calcPreGst=()=>{const dp=Number(m_dp.value)||0;m_preGst.value=dp?(dp/1.18).toFixed(2):'';}
window.exportModels=async()=>{const snap=await getDocs(collection(db,modelCollection));const arr=[];snap.forEach(d=>arr.push({id:d.id,...d.data()}));const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='models.json';a.click();}
window.openUserPanel=()=>window.location.href='index.html';
window.adminLogout=()=>window.location.href='admin-login.html';
loadModels();

/* ---------------- USER FUNCTIONS ---------------- */
const userCollection = "users";
let userEditId = null;

window.saveUser = async function(){
  const name=u_name.value.trim(),email=u_email.value.trim(),password=u_password.value.trim(),role=u_role.value.trim();
  if(!name||!email)return alert('Enter name and email');
  const data={name,email,password,role,updatedAt:new Date()};
  try{
    if(userEditId){await updateDoc(doc(db,userCollection,userEditId),data);alert('User updated')}
    else await addDoc(collection(db,userCollection),data),alert('User added');
    clearUserForm();loadUsers();
  }catch(e){alert('Error: '+e.message);}
}

window.loadUsers = async function(){
  const tbody=document.getElementById('usersTbody');tbody.innerHTML='<tr><td colspan=4>Loading...</td></tr>';
  const qText=(userFilter.value||'').toLowerCase();
  const snap=await getDocs(query(collection(db,userCollection),orderBy('name')));
  tbody.innerHTML='';let count=0;
  snap.forEach(d=>{
    const u=d.data(),id=d.id;
    if(qText&&!`${u.name} ${u.email}`.toLowerCase().includes(qText))return;
    count++;
    tbody.innerHTML+=`
    <tr><td>${u.name}</td><td>${u.email}</td><td>${u.role||'user'}</td>
    <td class='actions'><button class='edit' onclick="editUser('${id}')">Edit</button>
    <button class='del' onclick="deleteUser('${id}')">Delete</button></td></tr>`;
  });
  if(!count)tbody.innerHTML='<tr><td colspan=4>No users found</td></tr>';
}

window.editUser = async function(id){
  const snap=await getDoc(doc(db,userCollection,id));
  if(!snap.exists())return alert('Not found');
  const u=snap.data();userEditId=id;
  u_name.value=u.name||'';u_email.value=u.email||'';u_password.value=u.password||'';u_role.value=u.role||'';
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
}

window.deleteUser = async function(id){
  if(!confirm('Delete this user?'))return;
  await deleteDoc(doc(db,userCollection,id));loadUsers();
}

window.clearUserForm=()=>{userEditId=null;['u_name','u_email','u_password','u_role'].forEach(i=>document.getElementById(i).value='');}

loadUsers();
</script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, getDocs, getDoc, doc, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // your firebaseConfig here
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ‚úÖ make the function global
  window.saveUser = async function() {
    // your add/update code
    alert("saveUser is now working!");
  };

  // if you have loadUsers etc., also export them:
  window.loadUsers = async function() { /* ... */ };
  window.editUser  = async function(id) { /* ... */ };
  window.deleteUser = async function(id) { /* ... */ };
</script>

</body>
</html>

