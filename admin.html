<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kore Mobiles ‚Äî Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--blue:#007bff;--green:#28a745;--red:#dc3545;--bg:#f7f9fc}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg);color:#111}
.wrap{max-width:1200px;margin:18px auto;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
h2{color:var(--blue);margin:0;font-size:1.4rem}
.btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
.primary{background:var(--blue);color:#fff}
.logout{background:var(--red);color:#fff'}
.layout{display:grid;grid-template-columns:1fr 420px;gap:14px}
.panel{background:#fff;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
.form-row{display:flex;gap:10px;flex-wrap:wrap}
.form-row .half{flex:1;min-width:140px}
label{font-weight:600;font-size:.95rem;margin-top:6px;display:block}
.small{font-size:.95rem;color:#444}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:.95rem;vertical-align:middle}
.actions button{margin-right:6px;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
.edit{background:#ffc107;color:#111}
.del{background:#dc3545;color:#fff}
.add{background:var(--green);color:#fff}
.note{font-size:.9rem;color:#666;margin-top:8px}
.search-row{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.kv{font-size:0.95rem;color:#333}
@media(max-width:900px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <h2>‚öôÔ∏è Admin Dashboard ‚Äî Kore Mobiles</h2>
    <div style="display:flex;gap:8px">
      <a class="btn primary" href="index.html" style="text-decoration:none;color:#fff">Open User Panel</a>
      <button class="btn logout" onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <div class="layout">
    <!-- Left: Models list -->
    <div class="panel">
      <h3>üì± Models</h3>
      <div class="search-row">
        <input id="filterInput" placeholder="Filter by name / ram / rom" style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee" oninput="loadModels()" />
        <button class="btn" onclick="loadModels()">Refresh</button>
        <button class="btn" onclick="exportModels()">Export JSON</button>
      </div>

      <table class="table">
        <thead><tr><th>Model</th><th>MOP</th><th>DP</th><th>Pre-GST DP</th><th>Sellout</th><th>Sellin</th><th>CC Offers</th><th>Banks</th><th>Actions</th></tr></thead>
        <tbody id="modelsTbody"></tbody>
      </table>
      <p class="note">Data stored in Firestore collection <code>mobileModels</code>.</p>
    </div>

    <!-- Right: Add / Edit Model -->
    <div class="panel">
      <h3>Add / Edit Model</h3>

      <div>
        <label>Model Name</label>
        <input id="m_name" placeholder="e.g. Galaxy S24" />
      </div>

      <div class="form-row">
        <div class="half">
          <label>MOP (‚Çπ)</label>
          <input id="m_mop" type="number" />
        </div>
        <div class="half">
          <label>DP (‚Çπ)</label>
          <input id="m_dp" type="number" oninput="calcPreGst()" />
        </div>
      </div>

      <div class="form-row">
        <div class="half">
          <label>Pre-GST DP (auto)</label>
          <input id="m_preGst" readonly />
        </div>
        <div class="half">
          <label>Sellout Scheme (‚Çπ)</label>
          <input id="m_sellout" type="number" />
        </div>
      </div>

      <div class="form-row">
        <div class="half">
          <label>Sellin / Purchase Scheme (‚Çπ)</label>
          <input id="m_sellin" type="number" />
        </div>
        <div class="half">
          <label>RAM</label>
          <input id="m_ram" placeholder="e.g. 8GB" />
        </div>
      </div>

      <div class="form-row">
        <div class="half">
          <label>ROM</label>
          <input id="m_rom" placeholder="e.g. 128GB" />
        </div>
        <div class="half">
          <label>Credit Card No Cost EMI (‚Çπ)</label>
          <input id="m_cc_no" type="number" />
        </div>
      </div>

      <div class="form-row">
        <div class="half">
          <label>Credit Card Full Swipe (‚Çπ)</label>
          <input id="m_cc_full" type="number" />
        </div>
        <div class="half">
          <label>Eligible Banks (comma separated)</label>
          <input id="m_banks" placeholder="e.g. HDFC, SBI, ICICI" />
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn add" onclick="saveModel()">Save Model</button>
        <button class="btn" onclick="clearModelForm()">Clear</button>
      </div>
      <p class="note">Edit an existing model from the table ‚Äî it will load into the form for update.</p>
    </div>
  </div>

  <!-- User Management -->
  <div class="panel" style="margin-top:20px">
    <h3>üë• Users</h3>
    <div class="search-row">
      <input id="userFilter" placeholder="Search user by name or email" style="flex:1;padding:10px;border-radius:8px;border:1px solid #eee" oninput="loadUsers()"/>
      <button class="btn" onclick="loadUsers()">Refresh</button>
    </div>

    <table class="table">
      <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody id="usersTbody"></tbody>
    </table>

    <h4 style="margin-top:16px">Add / Edit User</h4>
    <div class="form-row">
      <div class="half"><label>Name</label><input id="u_name" placeholder="Full name"/></div>
      <div class="half"><label>Email</label><input id="u_email" placeholder="example@email.com"/></div>
    </div>
    <div class="form-row">
      <div class="half"><label>Password</label><input id="u_password" placeholder="Password"/></div>
      <div class="half"><label>Role</label><input id="u_role" placeholder="admin / user"/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn add" onclick="saveUser()">Save User</button>
      <button class="btn" onclick="clearUserForm()">Clear</button>
    </div>
  </div>

</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  getDoc,
  doc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  setDoc
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* ====== Your Firebase config (provided) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyByEiFSbsDlrCtVJjZgvbCoYPt_io2CpTk",
  authDomain: "nlcalulator.firebaseapp.com",
  projectId: "nlcalulator",
  storageBucket: "nlcalulator.firebasestorage.app",
  messagingSenderId: "783940164431",
  appId: "1:783940164431:web:edd9e24a8e6901942b433a",
  measurementId: "G-D8CXJYMPG0"
};
/* =========================================== */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- Models ---------------- */
const modelCollection = "mobileModels";
let modelEditId = null;

function fmt(n){ if(n===undefined||n===null||n==='') return '0'; return Number(n).toLocaleString('en-IN'); }

window.calcPreGst = function(){
  const dp = Number(document.getElementById('m_dp').value) || 0;
  document.getElementById('m_preGst').value = dp ? (dp/1.18).toFixed(2) : '';
};

window.saveModel = async function(){
  try {
    const name = document.getElementById('m_name').value.trim();
    if(!name) return alert('Enter model name');

    const mop = Number(document.getElementById('m_mop').value) || 0;
    const dp = Number(document.getElementById('m_dp').value) || 0;
    const preGstDp = dp ? Number((dp/1.18).toFixed(2)) : 0;
    const sellout = Number(document.getElementById('m_sellout').value) || 0;
    const sellin = Number(document.getElementById('m_sellin').value) || 0;
    const ram = document.getElementById('m_ram').value.trim() || '';
    const rom = document.getElementById('m_rom').value.trim() || '';
    const ccNo = Number(document.getElementById('m_cc_no').value) || 0;
    const ccFull = Number(document.getElementById('m_cc_full').value) || 0;
    const banksText = document.getElementById('m_banks').value.trim() || '';
    const eligibleBanks = banksText ? banksText.split(',').map(b=>b.trim()).filter(Boolean) : [];

    const payload = { name, mop, dp, preGstDp, sellout, sellin, ram, rom, ccNo, ccFull, eligibleBanks, updatedAt: new Date() };

    if (modelEditId) {
      await updateDoc(doc(db, modelCollection, modelEditId), payload);
      alert('‚úÖ Model updated successfully');
    } else {
      const docRef = await addDoc(collection(db, modelCollection), payload);
      alert('‚úÖ Model added ‚Äî id: ' + docRef.id);
    }
    clearModelForm();
    await loadModels();
  } catch (err) {
    console.error('Firestore save error:', err);
    alert('Error saving model. See console.');
  }
};

window.loadModels = async function(){
  const tbody = document.getElementById('modelsTbody');
  tbody.innerHTML = `<tr><td colspan="9">Loading...</td></tr>`;
  const qText = (document.getElementById('filterInput').value || '').trim().toLowerCase();
  try {
    const q = query(collection(db, modelCollection), orderBy('name'));
    const snap = await getDocs(q);
    tbody.innerHTML = '';
    let count = 0;
    snap.forEach(docSnap=>{
      const m = docSnap.data();
      const id = docSnap.id;
      if(qText){
        const hay = `${m.name||''} ${m.ram||''} ${m.rom||''}`.toLowerCase();
        if(!hay.includes(qText)) return;
      }
      count++;
      const banks = (m.eligibleBanks && m.eligibleBanks.length) ? m.eligibleBanks.join(', ') : '';
      const pre = m.preGstDp || (m.dp ? (m.dp/1.18).toFixed(2) : 0);
      tbody.innerHTML += `
        <tr>
          <td><strong>${m.name||''}</strong><div class="small">${m.ram||''}/${m.rom||''}</div></td>
          <td>‚Çπ${fmt(m.mop)}</td>
          <td>‚Çπ${fmt(m.dp)}</td>
          <td>‚Çπ${fmt(pre)}</td>
          <td>‚Çπ${fmt(m.sellout)}</td>
          <td>‚Çπ${fmt(m.sellin)}</td>
          <td class="kv">No Cost: ‚Çπ${fmt(m.ccNo)}<br>Full Swipe: ‚Çπ${fmt(m.ccFull)}</td>
          <td class="kv">${banks}</td>
          <td class="actions">
            <button class="edit" onclick="startEditModel('${id}')">Edit</button>
            <button class="del" onclick="deleteModel('${id}')">Delete</button>
          </td>
        </tr>
      `;
    });
    if(count===0){
      tbody.innerHTML = `<tr><td colspan="9">No models found.</td></tr>`;
    }
  } catch(err){
    console.error('Load models error', err);
    tbody.innerHTML = `<tr><td colspan="9">Error loading models ‚Äî check console.</td></tr>`;
  }
};

window.startEditModel = async function(id){
  try {
    const snap = await getDoc(doc(db, modelCollection, id));
    if(!snap.exists()){
      alert('Model not found');
      return;
    }
    const m = snap.data();
    modelEditId = id;
    document.getElementById('m_name').value = m.name || '';
    document.getElementById('m_mop').value = m.mop || '';
    document.getElementById('m_dp').value = m.dp || '';
    document.getElementById('m_preGst').value = m.preGstDp || '';
    document.getElementById('m_sellout').value = m.sellout || '';
    document.getElementById('m_sellin').value = m.sellin || '';
    document.getElementById('m_ram').value = m.ram || '';
    document.getElementById('m_rom').value = m.rom || '';
    document.getElementById('m_cc_no').value = m.ccNo || '';
    document.getElementById('m_cc_full').value = m.ccFull || '';
    document.getElementById('m_banks').value = (m.eligibleBanks && m.eligibleBanks.join(', ')) || '';
    window.scrollTo({top:0,behavior:'smooth'});
  } catch(err){
    console.error('Edit model error', err);
    alert('Error loading model for edit');
  }
};

window.deleteModel = async function(id){
  if(!confirm('Delete this model?')) return;
  try {
    await deleteDoc(doc(db, modelCollection, id));
    alert('Model deleted');
    loadModels();
  } catch(err){
    console.error('Delete model error', err);
    alert('Error deleting model');
  }
};

window.clearModelForm = function(){
  modelEditId = null;
  ['m_name','m_mop','m_dp','m_preGst','m_sellout','m_sellin','m_ram','m_rom','m_cc_no','m_cc_full','m_banks'].forEach(id=>document.getElementById(id).value='');
};

window.exportModels = async function(){
  try {
    const snap = await getDocs(collection(db, modelCollection));
    const arr = [];
    snap.forEach(d => { arr.push(Object.assign({ id: d.id }, d.data())); });
    const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'mobileModels-export.json'; a.click();
    URL.revokeObjectURL(url);
    alert('Exported '+arr.length+' records');
  } catch(err){
    console.error('Export error', err);
    alert('Error exporting models');
  }
};

/* ---------------- Users ---------------- */
const userCollection = "users";
let userEditId = null;

function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }

window.saveUser = async function(){
  try {
    const name = (document.getElementById('u_name').value || '').trim();
    const email = (document.getElementById('u_email').value || '').trim();
    const password = (document.getElementById('u_password').value || '').trim();
    const role = (document.getElementById('u_role').value || '').trim() || 'user';

    if(!name){ alert('Please enter a name'); return; }
    if(!email || !isValidEmail(email)){ alert('Please enter a valid email'); return; }

    const payload = { name, email, password: password||null, role, updatedAt: new Date() };

    if(userEditId){
      await updateDoc(doc(db, userCollection, userEditId), payload);
      alert('‚úÖ User updated successfully');
    } else {
      const docRef = await addDoc(collection(db, userCollection), payload);
      alert('‚úÖ User added ‚Äî id: ' + docRef.id);
    }
    clearUserForm();
    loadUsers();
  } catch (err) {
    console.error('saveUser error ->', err);
    if (err && err.code === 'permission-denied') {
      alert('Permission denied: Firestore rules block this write. Check rules or sign in.');
    } else {
      alert('Error saving user. See console.');
    }
  }
};

window.loadUsers = async function(){
  const tbody = document.getElementById('usersTbody');
  tbody.innerHTML = '<tr><td colspan=4>Loading...</td></tr>';
  try {
    const qText = (document.getElementById('userFilter').value || '').toLowerCase();
    const snap = await getDocs(query(collection(db, userCollection), orderBy('name')));
    tbody.innerHTML = '';
    let count = 0;
    snap.forEach(d=>{
      const u = d.data(), id = d.id;
      if(qText && !`${u.name||''} ${u.email||''}`.toLowerCase().includes(qText)) return;
      count++;
      tbody.innerHTML += `<tr>
        <td>${u.name||''}</td>
        <td>${u.email||''}</td>
        <td>${u.role||'user'}</td>
        <td class="actions">
          <button class="edit" onclick="startEditUser('${id}')">Edit</button>
          <button class="del" onclick="deleteUser('${id}')">Delete</button>
        </td>
      </tr>`;
    });
    if(!count) tbody.innerHTML = '<tr><td colspan=4>No users found</td></tr>';
  } catch(e){
    console.error('loadUsers error ->', e);
    tbody.innerHTML = '<tr><td colspan=4>Error loading users ‚Äî check console.</td></tr>';
  }
};

window.startEditUser = async function(id){
  try {
    const snap = await getDoc(doc(db, userCollection, id));
    if(!snap.exists()) return alert('User not found');
    const u = snap.data();
    userEditId = id;
    document.getElementById('u_name').value = u.name || '';
    document.getElementById('u_email').value = u.email || '';
    document.getElementById('u_password').value = u.password || '';
    document.getElementById('u_role').value = u.role || '';
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  } catch(e){
    console.error('startEditUser error ->', e);
    alert('Error loading user for edit');
  }
};

window.deleteUser = async function(id){
  if(!confirm('Delete this user?')) return;
  try {
    await deleteDoc(doc(db, userCollection, id));
    alert('User deleted');
    loadUsers();
  } catch(e){
    console.error('deleteUser error ->', e);
    alert('Error deleting user');
  }
};

window.clearUserForm = function(){
  userEditId = null;
  ['u_name','u_email','u_password','u_role'].forEach(i=>document.getElementById(i).value='');
};

/* Initial load */
loadModels();
loadUsers();

</script>
</body>
</html>
