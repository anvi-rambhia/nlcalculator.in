<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kore Mobiles — Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7faff;
      margin: 1em;
      color: #333;
    }
    h2 {
      color: #0066ff;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }
    .gear-icon {
      font-size: 1.5em;
      color: #a5a5a5;
    }
    .top-buttons {
      margin-bottom: 1.5em;
    }
    button {
      border: none;
      padding: 0.5em 1em;
      font-weight: 600;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 0.5em;
      transition: background-color 0.2s ease;
    }
    button.blue {
      background-color: #0069ff;
      color: white;
    }
    button.blue:hover {
      background-color: #0056cc;
    }
    button.red {
      background-color: #e02b3d;
      color: white;
    }
    button.red:hover {
      background-color: #b02029;
    }
    .container {
      display: flex;
      gap: 2em;
      flex-wrap: wrap;
    }
    section {
      background-color: white;
      padding: 1em 1.2em;
      border-radius: 15px;
      box-shadow: 0 0 6px #d0dbff;
    }
    .models-section {
      flex: 2 1 700px;
      min-width: 320px;
    }
    .form-section {
      flex: 1 1 380px;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 1.3em;
    }
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea {
      width: 100%;
      padding: 0.4em 0.6em;
      margin: 0.3em 0.6em 0.9em 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1em;
      box-sizing: border-box;
    }
    input[readonly] {
      background-color: #eee;
    }
    label {
      font-weight: 700;
      display: block;
      margin-bottom: 0.2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.8em;
      table-layout: fixed;
      word-wrap: break-word;
    }
    th, td {
      padding: 0.5em 0.3em;
      text-align: left;
      vertical-align: middle;
    }
    th {
      border-bottom: 2px solid #ccc;
    }
    td {
      border-bottom: 1px solid #eee;
    }
    td > strong {
      display: block;
    }
    td > span {
      color: gray;
      font-size: 0.85em;
    }
    .actions button {
      padding: 0.3em 0.6em;
      margin-right: 0.3em;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: background-color 0.2s ease;
      min-width: 60px;
    }
    .actions button.edit {
      background-color: #fdca04;
      color: black;
    }
    .actions button.edit:hover {
      background-color: #e0b300;
    }
    .actions button.delete {
      background-color: #e02b3d;
      color: white;
    }
    .actions button.delete:hover {
      background-color: #b02029;
    }
    .save-clear-export {
      display: flex;
      gap: 0.8em;
      margin-top: 0.6em;
    }
    .save-clear-export button {
      flex: 1;
    }
    .save-clear-export button.save {
      background-color: #198754;
      color: white;
    }
    .save-clear-export button.save:hover {
      background-color: #147442;
    }
    .save-clear-export button.clear,
    .save-clear-export button.export {
      background-color: #ddd;
      color: black;
    }
    .save-clear-export button.clear:hover,
    .save-clear-export button.export:hover {
      background-color: #bbb;
    }
    hr {
      margin: 1em 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .note {
      font-size: 0.85em;
      color: gray;
      margin-top: 1em;
    }

    /* Users section table */
    #usersSection table {
      font-size: 0.9em;
    }
    #usersSection td {
      white-space: nowrap;
    }
    #usersSection td input {
      width: 90%;
      padding: 0.3em 0.4em;
      margin: 0;
      font-size: 0.9em;
    }
    #usersSection .actions button {
      min-width: 50px;
      margin: 0 0.15em;
      padding: 0.3em 0.5em;
    }

  </style>
</head>
<body>

  <h2><span class="gear-icon">⚙️</span>Admin Dashboard</h2>

  <div class="top-buttons">
    <button class="blue" id="openUserPanelBtn">Open User Panel</button>
    <button class="red" id="logoutBtn">Logout</button>
  </div>

  <div class="container">
    <!-- Models Section -->
    <section class="models-section">
      <h3>Models</h3>
      <input
        type="text" id="filterInput"
        placeholder="Filter by name/ram/rom"
        title="Filter models by name, RAM or ROM"
      />
      <button id="refreshBtn">Refresh</button>

      <table>
        <thead>
          <tr>
            <th style="width: 140px;">Model</th>
            <th>MOP</th>
            <th>DP</th>
            <th>Pre-GST DP</th>
            <th>Sellout</th>
            <th>Sellin</th>
            <th style="width:130px;">CC Offers</th>
            <th style="width:100px;">Banks</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="modelsTableBody"></tbody>
      </table>

      <p class="note">
        Models are kept in localStorage for testing. You can export JSON if needed.
      </p>
    </section>

    <!-- Form Section -->
    <section class="form-section" style="overflow-y:auto; max-height: 90vh;">
      <!-- Model Form -->
      <div>
        <h3>Add / Edit Model</h3>

        <form id="modelForm" autocomplete="off">

          <label for="modelName">Model Name</label>
          <input
            type="text"
            id="modelName"
            placeholder="e.g. Galaxy S24 8GB/128GB"
            required
          />

          <div style="display: flex; gap: 1em; flex-wrap: wrap;">
            <div style="flex: 1;">
              <label for="mop">MOP (₹)</label>
              <input type="number" id="mop" min="0" step="1" required />
            </div>
            <div style="flex: 1;">
              <label for="dp">DP (₹)</label>
              <input type="number" id="dp" min="0" step="1" required />
            </div>
          </div>

          <div style="display: flex; gap: 1em; flex-wrap: wrap; margin-top: -10px;">
            <div style="flex: 1;">
              <label for="preGSTDP">Pre-GST DP (auto)</label>
              <input type="number" id="preGSTDP" readonly />
            </div>
            <div style="flex: 1;">
              <label for="sellout">Sellout Scheme (₹)</label>
              <input type="number" id="sellout" min="0" step="1" />
            </div>
          </div>

          <label for="sellin" style="margin-top: 0.8em;">Sellin / Purchase Scheme (₹)</label>
          <input type="number" id="sellin" min="0" step="1" />

          <hr />

          <h4>Credit Card Offers</h4>

          <div style="display: flex; gap: 1em; flex-wrap: wrap;">
            <div style="flex: 1;">
              <label for="ccNoCost">No Cost EMI Amount (₹)</label>
              <input type="number" id="ccNoCost" min="0" step="1" />
            </div>
            <div style="flex: 1;">
              <label for="ccFullSwipe">Full Swipe Amount (₹)</label>
              <input type="number" id="ccFullSwipe" min="0" step="1" />
            </div>
          </div>

          <label for="eligibleBanks" style="margin-top: 0.8em;">
            Eligible Banks (comma separated)
          </label>
          <textarea
            id="eligibleBanks"
            rows="3"
            placeholder="e.g. HDFC, SBI, ICICI"
          ></textarea>

          <div class="save-clear-export">
            <button type="submit" class="save">Save Model</button>
            <button type="button" id="clearBtn" class="clear">Clear</button>
            <button type="button" id="exportBtn" class="export">Export JSON</button>
          </div>
        </form>
      </div>

      <hr />

      <!-- Users Section -->
      <div id="usersSection">
        <h3>Users</h3>

        <form id="userForm" autocomplete="off">
          <label for="userEmail">Email</label>
          <input
            type="email"
            id="userEmail"
            placeholder="email@example.com"
            required
          />
          <label for="userPassword">Password</label>
          <input
            type="password"
            id="userPassword"
            placeholder="Password"
            required
          />
          <div style="display: flex; gap: 0.7em; margin-top: 0.8em;">
            <button type="submit" class="save" style="flex: 1;">Add / Update User</button>
            <button type="button" id="clearUserBtn" class="clear" style="flex: 1;">Clear</button>
            <button type="button" id="exportUsersBtn" class="export" style="flex: 1;">Export JSON</button>
          </div>
        </form>

        <table>
          <thead>
            <tr>
              <th style="width: 180px;">Email</th>
              <th>Password</th>
              <th style="width: 95px;">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>

        <p class="note">
          Users are stored in localStorage. Passwords shown here are NOT encrypted (demo only).
        </p>
      </div>
    </section>
  </div>

  <script>
    // Utility: Parse comma separated banks and trim
    function parseBanks(banksString) {
      return banksString
        .split(',')
        .map(b => b.trim())
        .filter(b => b.length > 0);
    }

    // --- Models Section ---
    const modelsTableBody = document.getElementById('modelsTableBody');
    const filterInput = document.getElementById('filterInput');
    const refreshBtn = document.getElementById('refreshBtn');

    const modelForm = document.getElementById('modelForm');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');

    const modelNameInput = document.getElementById('modelName');
    const mopInput = document.getElementById('mop');
    const dpInput = document.getElementById('dp');
    const preGSTDPInput = document.getElementById('preGSTDP');
    const selloutInput = document.getElementById('sellout');
    const sellinInput = document.getElementById('sellin');

    const ccNoCostInput = document.getElementById('ccNoCost');
    const ccFullSwipeInput = document.getElementById('ccFullSwipe');
    const eligibleBanksInput = document.getElementById('eligibleBanks');

    let models = [];
    let editModelIndex = null;

    // Load models from localStorage or defaults
    function loadModels() {
      const stored = localStorage.getItem('models');
      if (stored) {
        models = JSON.parse(stored);
      } else {
        models = [
          {
            modelName: 'Samsung S24',
            specs: '8GB/128GB',
            mop: 70000,
            dp: 56000,
            preGSTDP: 47457.63,
            sellout: 2000,
            sellin: 1500,
            ccOffers: {
              noCost: 2000,
              fullSwipe: 1500,
            },
            banks: ['HDFC', 'SBI']
          },
          {
            modelName: 'iPhone 15',
            specs: '6GB/128GB',
            mop: 79999,
            dp: 62000,
            preGSTDP: 52542.37,
            sellout: 3000,
            sellin: 2500,
            ccOffers: {
              noCost: 2500,
              fullSwipe: 1800,
            },
            banks: ['HDFC', 'ICICI']
          }
        ];
        saveModels();
      }
    }

    // Save models to localStorage
    function saveModels() {
      localStorage.setItem('models', JSON.stringify(models));
    }

    // Format amount as INR
    function formatINR(value) {
      if (value == null || isNaN(value)) return '-';
      return '₹' + Number(value).toLocaleString('en-IN');
    }

    // Calculate Pre-GST DP based on DP and GST assumed as 18%
    function calculatePreGSTDP(dp) {
      if (!dp || dp <= 0) return 0;
      return +(dp / 1.18).toFixed(2);
    }

    // Render models table and apply filter
    function renderModels(filter = '') {
      const lowerFilter = filter.toLowerCase();
      modelsTableBody.innerHTML = '';

      const filteredModels = models.filter(m => {
        return (
          m.modelName.toLowerCase().includes(lowerFilter) ||
          (m.specs && m.specs.toLowerCase().includes(lowerFilter))
        );
      });

      if (filteredModels.length === 0) {
        modelsTableBody.innerHTML = '<tr><td colspan="9" style="color: #888; text-align:center;">No models found matching the filter.</td></tr>';
        return;
      }

      filteredModels.forEach((model, index) => {
        let ccOffersText = '-';
        if (model.ccOffers && (model.ccOffers.noCost > 0 || model.ccOffers.fullSwipe > 0)) {
          ccOffersText = `NoCost:${model.ccOffers.noCost || 0} Full:${model.ccOffers.fullSwipe || 0}`;
        }

        const banksStr = model.banks ? model.banks.join(', ') : '-';
        const row = document.createElement('tr');

        row.innerHTML = `
          <td><strong>${model.modelName}</strong><br/><span>${model.specs || ''}</span></td>
          <td>${formatINR(model.mop)}</td>
          <td>${formatINR(model.dp)}</td>
          <td>${formatINR(model.preGSTDP)}</td>
          <td>${formatINR(model.sellout)}</td>
          <td>${formatINR(model.sellin)}</td>
          <td>${ccOffersText}</td>
          <td>${banksStr}</td>
          <td class="actions">
            <button class="edit" title="Edit Model">Edit</button>
            <button class="delete" title="Delete Model">Delete</button>
          </td>
        `;

        // Edit button
        row.querySelector('.edit').addEventListener('click', () => {
          editModelIndex = models.indexOf(model);
          populateModelForm(model);
          window.scrollTo({top: 0, behavior: 'smooth'});
        });

        // Delete button
        row.querySelector('.delete').addEventListener('click', () => {
          if(confirm(`Are you sure you want to delete model "${model.modelName}"?`)) {
            models.splice(models.indexOf(model), 1);
            saveModels();
            renderModels(filterInput.value);
            clearModelForm();
          }
        });

        modelsTableBody.appendChild(row);
      });
    }

    // Populate model form (edit mode)
    function populateModelForm(model) {
      modelNameInput.value = model.modelName;
      mopInput.value = model.mop;
      dpInput.value = model.dp;
      preGSTDPInput.value = model.preGSTDP;
      selloutInput.value = model.sellout || '';
      sellinInput.value = model.sellin || '';
      ccNoCostInput.value = (model.ccOffers && model.ccOffers.noCost) || '';
      ccFullSwipeInput.value = (model.ccOffers && model.ccOffers.fullSwipe) || '';
      eligibleBanksInput.value = (model.banks || []).join(', ');
    }

    // Clear model form & reset
    function clearModelForm() {
      modelForm.reset();
      preGSTDPInput.value = '';
      editModelIndex = null;
    }

    // Auto calculate Pre-GST DP when DP changes
    function autoCalculatePreGST() {
      const dpVal = parseFloat(dpInput.value);
      if (!isNaN(dpVal) && dpVal > 0) {
        preGSTDPInput.value = calculatePreGSTDP(dpVal);
      } else {
        preGSTDPInput.value = '';
      }
    }

    // Validate model before saving
    function validateModel(model) {
      if (!model.modelName.trim()) {
        alert('Model Name is required.');
        return false;
      }
      if (isNaN(model.mop) || model.mop <= 0) {
        alert('Valid MOP is required.');
        return false;
      }
      if (isNaN(model.dp) || model.dp <= 0) {
        alert('Valid DP is required.');
        return false;
      }
      if (isNaN(model.preGSTDP) || model.preGSTDP <= 0) {
        alert('Valid Pre-GST DP is required.');
        return false;
      }
      return true;
    }

    // Event listener for saving model (add or update)
    modelForm.addEventListener('submit', e => {
      e.preventDefault();

      const modelNameVal = modelNameInput.value.trim();
      // Attempt to extract specs from modelName if format includes (specs)
      let specs = '';
      const specsMatch = modelNameVal.match(/\((.+)\)$/);
      if (specsMatch) {
        specs = specsMatch[1];
      } else {
        // Or fallback parse RAM/ROM if included e.g. "Galaxy S24 8GB/128GB"
        const parts = modelNameVal.split(' ');
        const lastPart = parts[parts.length - 1];
        if (/^\d+GB\/\d+GB$/i.test(lastPart)) {
          specs = lastPart;
        }
      }

      const mopVal = parseFloat(mopInput.value);
      const dpVal = parseFloat(dpInput.value);
      const preGSTDPVal = parseFloat(preGSTDPInput.value);
      const selloutVal = parseFloat(selloutInput.value) || 0;
      const sellinVal = parseFloat(sellinInput.value) || 0;
      const ccNoCostVal = parseFloat(ccNoCostInput.value) || 0;
      const ccFullSwipeVal = parseFloat(ccFullSwipeInput.value) || 0;
      const eligibleBanksArr = parseBanks(eligibleBanksInput.value);

      const newModel = {
        modelName: modelNameVal,
        specs: specs,
        mop: mopVal,
        dp: dpVal,
        preGSTDP: preGSTDPVal,
        sellout: selloutVal,
        sellin: sellinVal,
        ccOffers: {
          noCost: ccNoCostVal,
          fullSwipe: ccFullSwipeVal,
        },
        banks: eligibleBanksArr,
      };

      if (!validateModel(newModel)) return;

      if (editModelIndex !== null) {
        models[editModelIndex] = newModel;
      } else {
        models.push(newModel);
      }
      saveModels();
      renderModels(filterInput.value);
      clearModelForm();
    });

    // Input event to update preGSTDP automatically
    dpInput.addEventListener('input', autoCalculatePreGST);

    // Filter input event for models
    filterInput.addEventListener('input', () => {
      renderModels(filterInput.value);
    });

    // Refresh models button
    refreshBtn.addEventListener('click', () => {
      loadModels();
      renderModels(filterInput.value);
    });

    // Clear model form button
    clearBtn.addEventListener('click', () => {
      clearModelForm();
    });

    // Export models JSON
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(models, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'models.json';
      a.click();

      URL.revokeObjectURL(url);
    });

    // --- Users Section ---
    const usersTableBody = document.getElementById('usersTableBody');
    const userForm = document.getElementById('userForm');
    const userEmailInput = document.getElementById('userEmail');
    const userPasswordInput = document.getElementById('userPassword');
    const clearUserBtn = document.getElementById('clearUserBtn');
    const exportUsersBtn = document.getElementById('exportUsersBtn');

    let users = [];
    let editUserIndex = null;

    // Load users from localStorage or initialize
    function loadUsers() {
      const stored = localStorage.getItem('users');
      if (stored) {
        users = JSON.parse(stored);
      } else {
        users = [
          { email: 'admin@example.com', password: 'admin123' }
        ];
        saveUsers();
      }
    }

    // Save users to localStorage
    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }

    // Render users table
    function renderUsers() {
      usersTableBody.innerHTML = '';
      if (users.length === 0) {
        usersTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888;">No users registered.</td></tr>`;
        return;
      }

      users.forEach((user, idx) => {
        const row = document.createElement('tr');
        // We create editable inputs inline for user email and password
        row.innerHTML = `
          <td><input type="email" class="user-email" value="${user.email}" required /></td>
          <td><input type="password" class="user-password" value="${user.password}" required /></td>
          <td class="actions">
            <button class="update" title="Update">Update</button>
            <button class="delete" title="Delete">Delete</button>
          </td>
        `;

        // Update button handler: update user email and password
        const updateBtn = row.querySelector('.update');
        updateBtn.addEventListener('click', () => {
          const updatedEmail = row.querySelector('.user-email').value.trim();
          const updatedPass = row.querySelector('.user-password').value;
          if (!updatedEmail || !updatedPass) {
            alert('Email and Password cannot be empty.');
            return;
          }
          // Basic email format validation
          if (!/\S+@\S+\.\S+/.test(updatedEmail)) {
            alert('Please enter a valid email address.');
            return;
          }
          users[idx].email = updatedEmail;
          users[idx].password = updatedPass;
          saveUsers();
          renderUsers();
          alert('User updated successfully.');
        });

        // Delete button handler
        const deleteBtn = row.querySelector('.delete');
        deleteBtn.addEventListener('click', () => {
          if(confirm(`Are you sure you want to delete user "${user.email}"?`)) {
            users.splice(idx,1);
            saveUsers();
            renderUsers();
          }
        });

        usersTableBody.appendChild(row);
      });
    }

    // Add or update user from userForm
    userForm.addEventListener('submit', e => {
      e.preventDefault();

      const emailVal = userEmailInput.value.trim();
      const passwordVal = userPasswordInput.value;

      if (!emailVal || !passwordVal) {
        alert('Email and Password are required.');
        return;
      }
      if (!/\S+@\S+\.\S+/.test(emailVal)) {
        alert('Please enter a valid email address.');
        return;
      }

      // Check if user exists - update password for existing user
      const existingIdx = users.findIndex(u => u.email.toLowerCase() === emailVal.toLowerCase());
      if (existingIdx >= 0) {
        users[existingIdx].password = passwordVal;
        alert('Existing user password updated.');
      } else {
        users.push({ email: emailVal, password: passwordVal });
        alert('New user added.');
      }
      saveUsers();
      renderUsers();
      clearUserForm();
    });

    // Clear user form
    function clearUserForm() {
      userForm.reset();
    }
    clearUserBtn.addEventListener('click', clearUserForm);

    // Export users JSON
    exportUsersBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(users, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'users.json';
      a.click();

      URL.revokeObjectURL(url);
    });

    // --- Top buttons ---
    const openUserPanelBtn = document.getElementById('openUserPanelBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    openUserPanelBtn.addEventListener('click', () => {
      alert('Open User Panel functionality not implemented.\nYou can navigate to your user panel here.');
    });

    logoutBtn.addEventListener('click', () => {
      alert('Logout functionality not implemented.\nImplement logout action here.');
    });

    // Initialize all data and rendering
    loadModels();
    renderModels();

    loadUsers();
    renderUsers();

  </script>

</body>
</html>
