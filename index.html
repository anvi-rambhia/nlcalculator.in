<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KORE Mobiles — NLC Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --blue: #007bff;
  --light-bg: #f5f7fb;
  --white: #fff;
  --shadow: 0 6px 18px rgba(0,0,0,0.07);
}
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: var(--light-bg);
  color: #111;
}

/* ===== Header ===== */
header {
  background: var(--white);
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  position: sticky;
  top: 0;
  z-index: 10;
}
header h2 {
  margin: 0;
  color: var(--blue);
  font-size: 1.2rem;
}
header div {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
header button {
  background: none;
  border: 1px solid var(--blue);
  color: var(--blue);
  border-radius: 8px;
  padding: 6px 14px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
}
header button:hover {
  background: var(--blue);
  color: #fff;
  transition: 0.3s;
}

/* ===== Login Box ===== */
.login-box {
  background: var(--white);
  padding: 30px;
  max-width: 360px;
  margin: 100px auto;
  border-radius: 12px;
  box-shadow: var(--shadow);
  text-align: center;
}
.login-box h3 {
  margin-bottom: 20px;
  color: var(--blue);
}
input {
  width: 95%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-bottom: 12px;
  font-size: 1rem;
}
button.primary {
  background: var(--blue);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  width: 100%;
}
button.primary:hover {
  opacity: 0.9;
}

/* ===== Container & Grid ===== */
.container {
  max-width: 1100px;
  margin: 25px auto;
  padding: 0 15px;
}
.search {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1rem;
  box-shadow: var(--shadow);
  background: var(--white);
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 18px;
  margin-top: 25px;
}
.card {
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 16px;
  transition: 0.3s ease;
}
.card:hover {
  transform: translateY(-3px);
}
.card h4 {
  color: var(--blue);
  margin: 0 0 8px;
  font-size: 1rem;
}
.info {
  font-size: 0.92rem;
  color: #333;
  margin-bottom: 6px;
  line-height: 1.4;
}

/* ===== Features List ===== */
.features-list {
  list-style-type: disc;
  margin: 4px 0 6px 18px;
  padding: 0;
  color: #333;
  font-size: 0.9rem;
}

/* ===== Calculation Box ===== */
.calc-box {
  margin-top: 10px;
  display: flex;
  gap: 10px;
  align-items: center;
}
.calc-box input {
  flex: 1;
  padding: 8px;
  font-size: 0.9rem;
}
.final {
  font-weight: 600;
  margin-top: 10px;
  color: #111;
}

/* ===== Mobile Adjustments ===== */
@media (max-width: 600px) {
  header {
    flex-direction: column;
    align-items: flex-start;
    padding: 12px 16px;
    gap: 6px;
  }
  header h2 {
    font-size: 1.1rem;
  }
  .login-box {
    margin: 60px 20px;
    padding: 25px;
  }
  .calc-box {
    flex-direction: column;
    align-items: stretch;
  }
  .calc-box button {
    width: 100%;
  }
}
</style>
</head>
<body>
<header>
  <h2>KORE Mobiles — NLC Calculator</h2>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn" onclick="logout()">Logout</button>
  </div>
</header>

<div id="loginPanel" class="login-box">
  <h3>Login to Continue</h3>
  <input id="loginEmail" type="email" placeholder="Email" />
  <input id="loginPass" type="password" placeholder="Password" />
  <button class="primary" onclick="login()">Login</button>
  <p id="loginMsg" style="color:red;font-size:0.9rem;"></p>
</div>

<div id="mainPanel" class="container" style="display:none;">
  <input id="search" class="search" type="text" placeholder="Search models by name, RAM, or ROM">
  <div id="modelsGrid" class="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyByEiFSbsDlrCtVJjZgvbCoYPt_io2CpTk",
  authDomain: "nlcalulator.firebaseapp.com",
  projectId: "nlcalulator",
  storageBucket: "nlcalulator.firebasestorage.app",
  messagingSenderId: "783940164431",
  appId: "1:783940164431:web:edd9e24a8e6901942b433a",
  measurementId: "G-D8CXJYMPG0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginPanel = document.getElementById("loginPanel");
const mainPanel = document.getElementById("mainPanel");
const modelsGrid = document.getElementById("modelsGrid");
const searchInput = document.getElementById("search");
const loginMsg = document.getElementById("loginMsg");
const userEmail = document.getElementById("userEmail");
let allModels = [];

onAuthStateChanged(auth, user => {
  if (user) {
    loginPanel.style.display = "none";
    mainPanel.style.display = "block";
    userEmail.textContent = "Welcome, " + user.email;
    loadModels();
  } else {
    loginPanel.style.display = "block";
    mainPanel.style.display = "none";
  }
});

window.login = async function() {
  const email = loginEmail.value.trim();
  const pass = loginPass.value.trim();
  loginMsg.textContent = "";
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    loginMsg.textContent = "Invalid credentials.";
  }
};

window.logout = async function() {
  await signOut(auth);
  loginEmail.value = "";
  loginPass.value = "";
  userEmail.textContent = "";
  mainPanel.style.display = "none";
  loginPanel.style.display = "block";
};

async function loadModels() {
  const snap = await getDocs(collection(db, "mobileModels"));
  allModels = [];
  snap.forEach(doc => {
    allModels.push({ id: doc.id, ...doc.data() });
  });
  renderModels([]);
}

searchInput.addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  if (!val) {
    modelsGrid.innerHTML = "";
    return;
  }
  const filtered = allModels.filter(m =>
    m.name.toLowerCase().includes(val)
  );
  renderModels(filtered);
});

function renderModels(models) {
  modelsGrid.innerHTML = "";
  if (!models.length) return;

  models.forEach(m => {
    const card = document.createElement("div");
    card.className = "card";

    const upgradeLine = (m.upgrade && m.upgrade !== "0" && m.upgrade !== "") 
      ? `<div class="info">Upgrade: ₹${m.upgrade}</div>` 
      : "";

    // Convert features into list points
    let featuresHtml = "";
    if (m.features) {
      const featuresArray = m.features.split(/[.,;\n]/).filter(f => f.trim() !== "");
      featuresHtml = `<ul class="features-list">${featuresArray.map(f => `<li>${f.trim()}</li>`).join("")}</ul>`;
    }

    card.innerHTML = `
      <h4>${m.name || ""}</h4>
      <div class="info">MOP: ₹${m.mop || 0}</div>
      <div class="info">Sellout: ₹${m.sellout || 0} | Sellin: ₹${m.sellin || 0}</div>
      <div class="info">No Cost EMI: ₹${m.noCostEmi || 0} | Full Swipe: ₹${m.fullSwipe || 0}</div>
      <div class="info">Eligible Banks: ${m.eligibleBanks || "-"}</div>
      ${upgradeLine}
      ${featuresHtml}
      <div class="calc-box">
        <input type="number" placeholder="Dealer %" class="dealerInput" style="flex:1.3; padding:10px; font-size:1rem;"/>
        <button class="primary calcBtn" style="padding:10px 14px; font-size:0.95rem;">Calculate NLC</button>
      </div>
      <div class="final">Final NLC: <span class="finalVal">—</span></div>
    `;

    const calcBtn = card.querySelector(".calcBtn");
    const dealerInput = card.querySelector(".dealerInput");
    const finalVal = card.querySelector(".finalVal");

    calcBtn.addEventListener("click", () => {
      const dealer = parseFloat(dealerInput.value);
      if (isNaN(dealer)) return alert("Enter valid dealer %");

      const name = (m.name || "").toLowerCase();
      const isIphone = name.includes("iphone") || name.includes("apple");
      const isSamsung = name.includes("samsung");

      let nlc;
      const dp = m.dp || 0;
      const preGstDp = m.preGstDp || 0;
      const sellout = m.sellout || 0;
      const sellin = m.sellin || 0;
      const upgrade = parseFloat(m.upgrade || 0);

      if (isIphone) {
        nlc = m.mop - (m.mop * dealer / 100);
      } else if (isSamsung) {
        nlc = dp - (preGstDp * dealer / 100) - sellout - sellin - (upgrade - 1000);
      } else {
        nlc = dp - (preGstDp * dealer / 100) - (sellout - (sellout * 0.18)) - sellin;
      }

      finalVal.textContent = "₹" + nlc.toFixed(2);
      finalVal.style.color = "#007bff";
      finalVal.style.fontWeight = "700";
    });

    modelsGrid.appendChild(card);
  });
}
</script>
</body>
</html>
